<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HR â€” Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© (XLSX) | Ù…Ø­Ù„ÙŠ</title>

  <!-- Ù†Ù…Ø· ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø³ÙŠØ· ÙˆØ§Ø­ØªØ±Ø§ÙÙŠ -->
  <style>
    :root{
      --bg:#0f172a;        /* slate-900 */
      --panel:#111827;     /* gray-900 */
      --card:#0b1220;      /* custom dark */
      --text:#e5e7eb;      /* gray-200 */
      --muted:#9ca3af;     /* gray-400 */
      --brand:#22c55e;     /* green-500 */
      --danger:#f87171;    /* red-400 */
      --warn:#f59e0b;      /* amber-500 */
      --chip:#1f2937;      /* gray-800 */
      --line:#1f2937;
      --ok:#16a34a; --bad:#b91c1c; --miss:#475569; /* states */
      --accent:#06b6d4;    /* cyan-500 */
      --btn:#1e293b;       /* slate-800 */
      --ring:#22d3ee;      /* cyan-400 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:15px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", "Tahoma", Arial, sans-serif;
    }
    .wrap{max-width:980px;margin:24px auto;padding:0 14px}
    h1{font-size:28px;margin:0 0 8px}
    .subtitle{color:var(--muted);margin-bottom:22px}
    .card{
      background:linear-gradient(180deg, var(--card), var(--panel));
      border:1px solid var(--line); border-radius:14px; padding:18px; margin:14px 0;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    label.h{display:block;font-weight:700;margin:2px 0 8px}
    .hint{color:var(--muted);font-size:13px;margin-top:6px}
    input[type="file"]{
      width:100%; background:var(--btn); color:var(--text); border:1px dashed #2b3344;
      padding:12px; border-radius:10px; cursor:pointer;
    }
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .btn{
      border:none; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:700;
      background:var(--btn); color:var(--text); border:1px solid #263042;
    }
    .btn.primary{background:var(--brand); border-color:var(--brand); color:#04210f}
    .btn.secondary{background:#0b3750;border-color:#0b3750}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .chips{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0 6px}
    .chip{
      background:var(--chip); color:var(--text); padding:8px 12px; border-radius:999px;
      border:1px solid #2a3344; cursor:pointer; user-select:none; font-weight:700;
    }
    .chip.active{outline:2px solid var(--ring)}
    .chip.ok{background:rgba(22,163,74,.12); color:#86efac; border-color:rgba(22,163,74,.3)}
    .chip.bad{background:rgba(185,28,28,.12); color:#fecaca; border-color:rgba(185,28,28,.3)}
    .chip.miss{background:rgba(71,85,105,.25); color:#cbd5e1; border-color:rgba(71,85,105,.4)}
    .search{position:relative;margin:8px 0 14px}
    .search input{
      width:100%; padding:12px 42px 12px 12px; border-radius:12px; background:#0b1220; color:var(--text);
      border:1px solid #263042;
    }
    .search .icon{position:absolute; right:10px; top:50%; transform:translateY(-50%); opacity:.7}
    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; border:1px solid var(--line)}
    th,td{padding:10px 12px; border-bottom:1px solid var(--line); text-align:center; white-space:nowrap}
    thead th{background:#0b1220; position:sticky; top:0; z-index:2}
    tbody tr:nth-child(2n){background:#0b1526}
    .k{opacity:.8}
    .state{font-weight:800; padding:6px 10px; border-radius:8px; display:inline-block}
    .okbg{background:rgba(22,163,74,.12); color:#86efac}
    .badbg{background:rgba(185,28,28,.12); color:#fecaca}
    .missbg{background:rgba(71,85,105,.25); color:#cbd5e1}
    .note{color:#cbd5e1}
    .footer{color:#9aa3b2; text-align:center; margin:24px 0 8px; font-size:13px}
    .tag{font-weight:700;color:#67e8f9}
    .ver{color:#9ca3af;font-size:12px;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>HR â€” Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© (XLSX) <span class="tag">Ù…Ø­Ù„ÙŠ (Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª)</span></h1>
    <div class="subtitle">ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØªÙ… Ø¯Ø§Ø®Ù„ Ù…ØªØµÙØ­Ùƒ. Ù„Ø§ ÙŠØªÙ… Ø±ÙØ¹ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø®Ø§Ø¯Ù….</div>

    <div class="card">
      <div class="row">
        <div class="col">
          <label class="h">ğŸ“‚ Ù…Ù„Ù Ø§Ù„Ø¨ØµÙ…Ø© (XLSX)</label>
          <div class="hint">Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: <b>Ø§Ù„ÙƒÙˆØ¯ | Ø§Ù„Ø§Ø³Ù… | Øº | Ø±</b></div>
          <input type="file" id="f-fp" accept=".xlsx,.xls" />
          <div class="hint" id="fpMeta"></div>
        </div>
        <div class="col">
          <label class="h">ğŸ“‚ Ø§Ù„ÙƒØ´Ù Ø§Ù„ÙŠØ¯ÙˆÙŠ (XLSX)</label>
          <div class="hint">Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: <b>Ø§Ù„ÙƒÙˆØ¯ | Ø§Ù„Ø§Ø³Ù… | Øº | Ø±</b></div>
          <input type="file" id="f-manual" accept=".xlsx,.xls" />
          <div class="hint" id="mnMeta"></div>
        </div>
      </div>

      <div class="actions">
        <button id="btnExport" class="btn secondary" disabled>ğŸ’¾ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ XLSX</button>
        <button id="btnRun" class="btn primary" disabled>ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</button>
      </div>

      <div class="chips">
        <span class="chip" data-filter="all">Ø§Ù„ÙƒÙ„ <b id="cAll">0</b></span>
        <span class="chip ok" data-filter="ok">Ù…Ø·Ø§Ø¨Ù‚ <b id="cOk">0</b></span>
        <span class="chip bad" data-filter="bad">Ù…Ø®Ø§Ù„Ù <b id="cBad">0</b></span>
        <span class="chip miss" data-filter="miss">Ù†Ø§Ù‚Øµ/ØºÙŠØ± Ù…ÙƒØªÙ…Ù„ <b id="cMiss">0</b></span>
      </div>

      <div class="search">
        <input id="q" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..." />
        <span class="icon">ğŸ”</span>
      </div>

      <div class="table card">
        <table id="tbl">
          <thead>
          <tr>
            <th class="k">Ù…</th>
            <th>Ø§Ù„ÙƒÙˆØ¯ (Ø¨ØµÙ…Ø©)</th>
            <th>Ø§Ù„Ø§Ø³Ù… (Ø¨ØµÙ…Ø©)</th>
            <th>Øº (Ø¨ØµÙ…Ø©)</th>
            <th>Ø± (Ø¨ØµÙ…Ø©)</th>
            <th>Ø§Ù„Ø§Ø³Ù… (ÙŠØ¯ÙˆÙŠ)</th>
            <th>Øº (ÙŠØ¯ÙˆÙŠ)</th>
            <th>Ø± (ÙŠØ¯ÙˆÙŠ)</th>
            <th>Ù†ØªÙŠØ¬Ø© Øº</th>
            <th>Ù†ØªÙŠØ¬Ø© Ø±</th>
            <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>
          </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div class="ver">Ø§Ù„Ø¥ØµØ¯Ø§Ø±: v1.7 â€” ØªÙ‚Ø±ÙŠØ¨ Ø¹Ø´Ø±ÙŠ Ø¯Ù‚ÙŠÙ‚ â€¢ ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ÙƒÙˆØ¯ â€¢ Ù‚Ø§Ø¹Ø¯Ø© 31â†’30 â€¢ ØªØ·Ø¨ÙŠØ¹ Ù…Ø±Ù† Ù„Ù„Ø£Ø³Ù…Ø§Ø¡ â€¢ ØªØµØ¯ÙŠØ± XLSX Ø¨Ø¯ÙˆÙ† ØªÙ„ÙˆÙŠÙ†.</div>
    </div>

    <div class="footer">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© â€” Ø¥Ø¹Ø¯Ø§Ø¯ <b>Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³/ Ø­Ù…Ø¯ÙŠ Ø§Ù„Ø¹Ø±ÙŠÙÙŠ</b> â€¢ Ø§Ù„ÙŠÙ…Ù† â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2025</div>
  </div>

  <!-- Ù…ÙƒØªØ¨Ø© Excel Ù…Ø­Ù„ÙŠØ© (Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯) -->
  <script src="xlsx.full.min.js"></script>

  <script>
  /************* Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© *************/
  const $ = (s) => document.querySelector(s);
  const fmt = (v) => (v===null||v===undefined||v==="") ? "" : v;
  const toNum = (x) => {
    if (x===null || x===undefined || x==="") return 0;
    const n = typeof x==='number' ? x : parseFloat(String(x).replace(/[^\d.-]/g,""));
    return isNaN(n) ? 0 : n;
  };
  // ØªÙ‚Ø±ÙŠØ¨ Ø¯Ù‚ÙŠÙ‚ Ù„Ø±Ù‚Ù…ÙŠÙ† Ø¹Ø´Ø±ÙŠÙŠÙ†
  const round2 = (n) => Math.round((toNum(n) + Number.EPSILON) * 100) / 100;

  // ØªØ­ÙˆÙŠÙ„ 31 ÙÙŠ (Øº) Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø¥Ù„Ù‰ 30
  const cap30 = (g) => (round2(g) === 31 ? 30 : round2(g));

  // ØªØ·Ø¨ÙŠØ¹ Ø§Ù„ÙƒÙˆØ¯ ÙƒØ³Ù„Ø³Ù„Ø© (Ù…Ù†Ø¹ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø£ØµÙØ§Ø±/Ø§Ù„ÙÙˆØ§ØµÙ„)
  const normCode = (v) => {
    if (v===null || v===undefined) return "";
    let s = String(v).trim();
    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ ÙƒØ³ÙˆØ± Ù†Ø§ØªØ¬Ø© Ø¹Ù† Ø§Ù„Ø¥ÙƒØ³Ù„
    if (/^\d+(\.\d+)?$/.test(s)) s = String(Math.trunc(Number(s)));
    return s;
  };

  // ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ´ÙƒÙŠÙ„ØŒ ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø£Ù„Ù/Ø§Ù„ÙŠØ§Ø¡/Ø§Ù„ØªØ§Ø¡ Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©ØŒ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙØ±Ø§ØºØ§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©)
  const normName = (name) => {
    if (!name) return "";
    let s = String(name).trim();
    s = s.normalize('NFKC')
         .replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED]/g,'') // ØªØ´ÙƒÙŠÙ„
         .replace(/[^\p{L}\p{N}\s]/gu,' ') // Ø±Ù…ÙˆØ²
         .replace(/[Ø¢Ø¥Ø£]/g,'Ø§').replace(/Ù‰/g,'ÙŠ').replace(/Ø©/g,'Ù‡')
         .replace(/\s+/g,' ').trim();
    return s;
  };

  // ØªØ´Ø§Ø¨Ù‡ Ø£Ø³Ù…Ø§Ø¡ Ø¨Ø³ÙŠØ·: ØªÙ‚Ø§Ø·Ø¹ ÙƒÙ„Ù…Ø§Øª Ø¨Ù†Ø³Ø¨Ø© >= 0.6
  const nameClose = (a,b) => {
    a = normName(a); b = normName(b);
    if (!a || !b) return false;
    if (a === b) return true;
    const ta = new Set(a.split(' '));
    const tb = new Set(b.split(' '));
    let inter = 0;
    for (const w of ta) if (tb.has(w)) inter++;
    const jaccard = inter / new Set([...ta,...tb]).size;
    return jaccard >= 0.6;
  };

  // Ù‚Ø±Ø§Ø¡Ø© ÙˆØ±Ù‚Ø© Ø¥ÙƒØ³Ù„ ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù†Ø§Øª
  const readXlsx = async (file) => {
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, {type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, {defval:"", raw:true});
    return rows;
  };

  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ø¹Ù…Ø¯Ø© Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¥Ø°Ø§ Ø§Ø®ØªÙ„Ù Ø§Ù„ØªØ±ØªÙŠØ¨
  const pluck = (rows) => {
    // Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
    const aliases = {
      "Ø§Ù„ÙƒÙˆØ¯":["Ø§Ù„ÙƒÙˆØ¯","ÙƒÙˆØ¯","code","id","Ø§Ù„Ø±Ù‚Ù…"],
      "Ø§Ù„Ø§Ø³Ù…":["Ø§Ù„Ø§Ø³Ù…","Ø§Ø³Ù…","name"],
      "Øº":["Øº","ØºÙŠØ§Ø¨","absent","a"],
      "Ø±":["Ø±","Ø§Ø¬Ø§Ø²Ù‡","Ø¥Ø¬Ø§Ø²Ø©","Ø§Ø¬Ø§Ø²Ø©","leave","r"]
    };
    const header = rows.length ? Object.keys(rows[0]) : [];
    const map = {};
    for (const key of Object.keys(aliases)){
      const list = aliases[key];
      const hit = header.find(h => list.includes(normName(h)));
      map[key] = hit || key; // Ø¥Ù† Ù„Ù… ÙŠÙˆØ¬Ø¯ Ù†Ø¨Ù‚ÙŠÙ‡ ÙƒÙ…Ø§ Ù‡Ùˆ
    }
    // ØªØ­ÙˆÙŠÙ„
    return rows.map(r => ({
      "Ø§Ù„ÙƒÙˆØ¯": fmt(r[map["Ø§Ù„ÙƒÙˆØ¯"]]),
      "Ø§Ù„Ø§Ø³Ù…": fmt(r[map["Ø§Ù„Ø§Ø³Ù…"]]),
      "Øº": fmt(r[map["Øº"]]),
      "Ø±": fmt(r[map["Ø±"]]),
    }));
  };

  /************* Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© *************/
  let fpRows = [], mnRows = [], allResults = [], currentFilter = 'all', query = '';

  const refreshCounters = () => {
    const cAll = allResults.length;
    const cOk  = allResults.filter(x => x._state==='ok').length;
    const cBad = allResults.filter(x => x._state==='bad').length;
    const cMiss= allResults.filter(x => x._state==='miss').length;
    $("#cAll").textContent = cAll;
    $("#cOk").textContent = cOk;
    $("#cBad").textContent = cBad;
    $("#cMiss").textContent = cMiss;
  };

  const render = () => {
    const tbody = $("#rows"); tbody.innerHTML = "";
    const q = normName(query);
    let list = allResults.slice();

    if (currentFilter !== 'all'){
      list = list.filter(x => x._state === currentFilter);
    }
    if (q){
      list = list.filter(x =>
        normCode(x["Ø§Ù„ÙƒÙˆØ¯"]) .includes(q) ||
        normName(x["Ø§Ù„Ø§Ø³Ù… (Ø¨ØµÙ…Ø©)"]).includes(q) ||
        normName(x["Ø§Ù„Ø§Ø³Ù… (ÙŠØ¯ÙˆÙŠ)"]).includes(q)
      );
    }
    // ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„ÙƒÙˆØ¯ ØªØµØ§Ø¹Ø¯ÙŠÙ‹Ø§
    list.sort((a,b)=> normCode(a["Ø§Ù„ÙƒÙˆØ¯"]).localeCompare(normCode(b["Ø§Ù„ÙƒÙˆØ¯"]), 'ar'));

    list.forEach((r,i)=>{
      const tr = document.createElement('tr');
      const stG = r["Ù†ØªÙŠØ¬Ø© Øº"]==="Ù…Ø·Ø§Ø¨Ù‚" ? 'okbg' : (r["Ù†ØªÙŠØ¬Ø© Øº"]==="Ù†Ø§Ù‚Øµ" ? 'missbg' : 'badbg');
      const stR = r["Ù†ØªÙŠØ¬Ø© Ø±"]==="Ù…Ø·Ø§Ø¨Ù‚" ? 'okbg' : (r["Ù†ØªÙŠØ¬Ø© Ø±"]==="Ù†Ø§Ù‚Øµ" ? 'missbg' : 'badbg');

      tr.innerHTML = `
        <td class="k">${i+1}</td>
        <td>${fmt(r["Ø§Ù„ÙƒÙˆØ¯"])}</td>
        <td style="text-align:right">${fmt(r["Ø§Ù„Ø§Ø³Ù… (Ø¨ØµÙ…Ø©)"])}</td>
        <td>${fmt(r["Øº (Ø¨ØµÙ…Ø©)"])}</td>
        <td>${fmt(r["Ø± (Ø¨ØµÙ…Ø©)"])}</td>
        <td style="text-align:right">${fmt(r["Ø§Ù„Ø§Ø³Ù… (ÙŠØ¯ÙˆÙŠ)"])}</td>
        <td>${fmt(r["Øº (ÙŠØ¯ÙˆÙŠ)"])}</td>
        <td>${fmt(r["Ø± (ÙŠØ¯ÙˆÙŠ)"])}</td>
        <td><span class="state ${stG}">${fmt(r["Ù†ØªÙŠØ¬Ø© Øº"])}</span></td>
        <td><span class="state ${stR}">${fmt(r["Ù†ØªÙŠØ¬Ø© Ø±"])}</span></td>
        <td class="note">${fmt(r["Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©"])}</td>
      `;
      tbody.appendChild(tr);
    });
  };

  $("#q").addEventListener('input', e => { query = e.target.value; render(); });
  document.querySelectorAll('.chip').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
      ch.classList.add('active');
      currentFilter = ch.getAttribute('data-filter');
      render();
    });
  });

  const enableRun = () => {
    const ok = fpRows.length>0 && mnRows.length>0;
    $("#btnRun").disabled = !ok;
  };

  /************* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª *************/
  $("#f-fp").addEventListener('change', async (e)=>{
    const f = e.target.files[0];
    if (!f) return;
    $("#fpMeta").textContent = `ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: ${f.name}`;
    const rows = await readXlsx(f);
    fpRows = pluck(rows);
    enableRun();
  });

  $("#f-manual").addEventListener('change', async (e)=>{
    const f = e.target.files[0];
    if (!f) return;
    $("#mnMeta").textContent = `ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: ${f.name}`;
    const rows = await readXlsx(f);
    mnRows = pluck(rows);
    enableRun();
  });

  /************* Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© *************/
  $("#btnRun").addEventListener('click', ()=>{
    if (!fpRows.length || !mnRows.length){
      alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø®ØªØ± Ù…Ù„ÙÙŠÙ‘ Ø§Ù„Ø¨ØµÙ…Ø© ÙˆØ§Ù„ÙŠØ¯ÙˆÙŠ (XLSX) Ø£ÙˆÙ„Ù‹Ø§.");
      return;
    }

    const manualByCode = new Map();
    mnRows.forEach(r=>{
      const code = normCode(r["Ø§Ù„ÙƒÙˆØ¯"]);
      if (!manualByCode.has(code)) manualByCode.set(code, []);
      manualByCode.get(code).push(r);
    });

    const results = [];
    fpRows.forEach(row=>{
      const code = normCode(row["Ø§Ù„ÙƒÙˆØ¯"]);
      const nameF = fmt(row["Ø§Ù„Ø§Ø³Ù…"]);
      const gF = round2(row["Øº"]);
      const rF = round2(row["Ø±"]);

      const cands = manualByCode.get(code) || [];
      // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙØ¶Ù„ Ù…Ø±Ø´Ø­ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù…
      let best = null, note = "";
      if (cands.length){
        // Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ø£ÙˆÙ„Ù‹Ø§
        best = cands.find(m => normName(m["Ø§Ù„Ø§Ø³Ù…"]) === normName(nameF));
        if (!best){
          // ØªØ·Ø¨ÙŠØ¹ Ù…Ø±Ù†
          best = cands.find(m => nameClose(m["Ø§Ù„Ø§Ø³Ù…"], nameF));
          if (best) note = "ØªØ·Ø¨ÙŠØ¹ Ù…Ø±Ù†: Ø§Ø®ØªÙ„Ø§Ù Ø§Ø³Ù…";
        }
        if (!best){
          // Ø¥Ù† Ù„Ù… Ù†Ø¬Ø¯ Ø§Ø³Ù…Ù‹Ø§ Ù…Ù‚Ø§Ø±Ø¨Ù‹Ø§ Ù†Ø£Ø®Ø° Ø£ÙˆÙ„ Ø³Ø·Ø± Ù„Ù†ÙØ¸Ù‡Ø± Ø£Ù†Ù‡ Ù…ÙˆØ¬ÙˆØ¯ ØªØ­Øª Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯
          best = cands[0];
          note = "ØªÙ†Ø¨ÙŠÙ‡: Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ Ø§Ø³Ù… Ù…Ø®ØªÙ„Ù";
        }
      }

      if (!best){
        // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„ÙŠØ¯ÙˆÙŠ â†’ Ù†Ø§Ù‚Øµ
        results.push({
          "Ø§Ù„ÙƒÙˆØ¯": code,
          "Ø§Ù„Ø§Ø³Ù… (Ø¨ØµÙ…Ø©)": nameF,
          "Øº (Ø¨ØµÙ…Ø©)": gF,
          "Ø± (Ø¨ØµÙ…Ø©)": rF,
          "Ø§Ù„Ø§Ø³Ù… (ÙŠØ¯ÙˆÙŠ)": "",
          "Øº (ÙŠØ¯ÙˆÙŠ)": "",
          "Ø± (ÙŠØ¯ÙˆÙŠ)": "",
          "Ù†ØªÙŠØ¬Ø© Øº": "Ù†Ø§Ù‚Øµ",
          "Ù†ØªÙŠØ¬Ø© Ø±": "Ù†Ø§Ù‚Øµ",
          "Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©": "Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ© Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„ÙƒØ´Ù Ø§Ù„ÙŠØ¯ÙˆÙŠ",
          _state: "miss"
        });
        return;
      }

      // Ù‚ÙŠÙ… Ø§Ù„ÙŠØ¯ÙˆÙŠ (Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© 31 -> 30 ÙÙŠ Øº)
      const gM = cap30(best["Øº"]);
      const rM = round2(best["Ø±"]);

      // Ù…Ù‚Ø§Ø±Ù†Ø©
      let resG = "Ù…Ø·Ø§Ø¨Ù‚", resR = "Ù…Ø·Ø§Ø¨Ù‚";
      let extra = "";

      if (gF !== gM){
        resG = "Ù…Ø®Ø§Ù„Ù";
        extra = (gF > gM) ? "ÙŠØªÙ… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Øº"
                          : `Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ ÙŠÙØ³ØªÙˆÙÙ‰ Øº Ø¨Ø§Ù„ÙØ§Ø±Ù‚ ${(gM - gF).toFixed(1)}`;
      }
      if (rF !== rM){
        resR = "Ù…Ø®Ø§Ù„Ù";
        if (!extra) extra = (rF > rM) ? "ÙŠØªÙ… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø±"
                                      : `Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ ÙŠÙØ³Ø¬Ù‘ÙÙ„ Ø± Ø¨Ø§Ù„ÙØ§Ø±Ù‚ ${(rM - rF).toFixed(1)}`;
      }

      // Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ Ù†ÙƒØªØ¨ "Ù…Ø·Ø§Ø¨Ù‚". Ù†ÙƒØªØ¨ ÙÙ‚Ø· Ø§Ù„ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ù…Ø±Ù†/Ø§Ù„Ù…Ø®Ø§Ù„Ù/Ø§Ù„Ù†Ø§Ù‚Øµ.
      let finalNote = "";
      if (note) finalNote = note;            // ØªØ·Ø¨ÙŠØ¹ Ù…Ø±Ù†
      if (extra) finalNote = finalNote ? (finalNote + " â€¢ " + extra) : extra;

      const state = (resG==="Ù…Ø·Ø§Ø¨Ù‚" && resR==="Ù…Ø·Ø§Ø¨Ù‚") ? "ok"
                    : (resG==="Ù†Ø§Ù‚Øµ" || resR==="Ù†Ø§Ù‚Øµ") ? "miss" : "bad";

      results.push({
        "Ø§Ù„ÙƒÙˆØ¯": code,
        "Ø§Ù„Ø§Ø³Ù… (Ø¨ØµÙ…Ø©)": nameF,
        "Øº (Ø¨ØµÙ…Ø©)": gF,
        "Ø± (Ø¨ØµÙ…Ø©)": rF,
        "Ø§Ù„Ø§Ø³Ù… (ÙŠØ¯ÙˆÙŠ)": fmt(best["Ø§Ù„Ø§Ø³Ù…"]),
        "Øº (ÙŠØ¯ÙˆÙŠ)": gM,
        "Ø± (ÙŠØ¯ÙˆÙŠ)": rM,
        "Ù†ØªÙŠØ¬Ø© Øº": resG,
        "Ù†ØªÙŠØ¬Ø© Ø±": resR,
        "Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©": finalNote,
        _state: state
      });
    });

    allResults = results;
    refreshCounters();
    $("#btnExport").disabled = allResults.length===0;
    // Ø§Ø¶Ø¨Ø· Ø§Ù„ÙÙ„ØªØ± Ø¹Ù„Ù‰ "Ø§Ù„ÙƒÙ„" Ø¹Ù†Ø¯ ÙƒÙ„ ØªØ´ØºÙŠÙ„
    currentFilter = 'all';
    document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
    document.querySelector('.chip[data-filter="all"]').classList.add('active');
    render();
  });

  /************* ØªØµØ¯ÙŠØ± XLSX *************/
  $("#btnExport").addEventListener('click', ()=>{
    if (!allResults.length) return;
    // ØªØ±ØªÙŠØ¨ Ù‚Ø¨Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±
    const out = allResults.slice().sort((a,b)=> normCode(a["Ø§Ù„ÙƒÙˆØ¯"]).localeCompare(normCode(b["Ø§Ù„ÙƒÙˆØ¯"]),'ar'))
      .map((r,idx)=>({
        "Ù…": idx+1,
        "Ø§Ù„ÙƒÙˆØ¯ (Ø¨ØµÙ…Ø©)": r["Ø§Ù„ÙƒÙˆØ¯"],
        "Ø§Ù„Ø§Ø³Ù… (Ø¨ØµÙ…Ø©)": r["Ø§Ù„Ø§Ø³Ù… (Ø¨ØµÙ…Ø©)"],
        "Øº (Ø¨ØµÙ…Ø©)": r["Øº (Ø¨ØµÙ…Ø©)"],
        "Ø± (Ø¨ØµÙ…Ø©)": r["Ø± (Ø¨ØµÙ…Ø©)"],
        "Ø§Ù„Ø§Ø³Ù… (ÙŠØ¯ÙˆÙŠ)": r["Ø§Ù„Ø§Ø³Ù… (ÙŠØ¯ÙˆÙŠ)"],
        "Øº (ÙŠØ¯ÙˆÙŠ)": r["Øº (ÙŠØ¯ÙˆÙŠ)"],
        "Ø± (ÙŠØ¯ÙˆÙŠ)": r["Ø± (ÙŠØ¯ÙˆÙŠ)"],
        "Ù†ØªÙŠØ¬Ø© Øº": r["Ù†ØªÙŠØ¬Ø© Øº"],
        "Ù†ØªÙŠØ¬Ø© Ø±": r["Ù†ØªÙŠØ¬Ø© Ø±"],
        "Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©": r["Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©"] || ""
      }));

    const ws = XLSX.utils.json_to_sheet(out);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "canary_monthly_result");
    XLSX.writeFile(wb, "canary_monthly_result.xlsx");
  });
  </script>
</body>
</html>
